= Active Directoryをidentity Providerとして設定する方法
Akiyoshi Yonekura <akiyoshi.yonekura@hpe.com>
v1.0, 2019-05-28
:toc:
== 手順
=== 389 Directory Serverの構成
. 参考
+
https://sky-joker.tech/2019/02/02/awxansible-tower%E3%81%A8389-directory-server%E3%81%A6%E3%82%99%E3%83%A6%E3%83%BC%E3%82%B5%E3%82%99%E3%83%BC%E8%AA%8D%E8%A8%BC%E9%80%A3%E6%90%BA%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F/
+
https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/7/html/linux_domain_identity_authentication_and_policy_guide/required-packages

. 事前準備
.. RHEL7.5がインストール(minimal)
.. ホスト名が設定されていること
.. ネットワーク設定が済んでいること
.. subscriptionの適用済み
.. ホスト名が名前解決できること

. Identity Managerのインストール
389 Directory Serverは、Identity Managerの依存パッケージとしてインストールされます。389 Directory Serverのみをインストールすることはサポートされません。
+
----
# yum install ipa-server
----

. チューニング
+
----
# echo "net.ipv4.ip_local_port_range = 1024 65000" >> /etc/sysctl.d/ldap.conf
# echo "fs.file-max = 64000" >> /etc/sysctl.d/ldap.conf
# echo "* soft nofile 8192" >> /etc/security/limits.conf
# echo "* hard nofile 8192" >> /etc/security/limits.conf
----

. 設定反映のため再起動

. 389 directory serverのセットアップ
+
----
# setup-ds.pl

==============================================================================
This program will set up the 389 Directory Server.

It is recommended that you have "root" privilege to set up the software.
Tips for using this  program:
  - Press "Enter" to choose the default and go to the next screen
  - Type "Control-B" or the word "back" then "Enter" to go back to the previous screen
  - Type "Control-C" to cancel the setup program

Would you like to continue with set up? [yes]: yes

==============================================================================
Your system has been scanned for potential problems, missing patches,
etc.  The following output is a report of the items found that need to
be addressed before running this software in a production
environment.

389 Directory Server system tuning analysis version 14-JULY-2016.

NOTICE : System is x86_64-unknown-linux3.10.0-957.el7.x86_64 (2 processors).

Would you like to continue? [yes]: yes

==============================================================================
Choose a setup type:

   1. Express
       Allows you to quickly set up the servers using the most
       common options and pre-defined defaults. Useful for quick
       evaluation of the products.

   2. Typical
       Allows you to specify common defaults and options.

   3. Custom
       Allows you to specify more advanced options. This is
       recommended for experienced server administrators only.

To accept the default shown in brackets, press the Enter key.

Choose a setup type [2]: 2

==============================================================================
Enter the fully qualified domain name of the computer
on which you're setting up server software. Using the form
<hostname>.<domainname>
Example: eros.example.com.

To accept the default shown in brackets, press the Enter key.

Warning: This step may take a few minutes if your DNS servers
can not be reached or if DNS is not configured correctly.  If
you would rather not wait, hit Ctrl-C and run this program again
with the following command line option to specify the hostname:

    General.FullMachineName=your.hostname.domain.name

Computer name [ldap01.vlan011.cnta.local]:

==============================================================================
The server must run as a specific user in a specific group.
It is strongly recommended that this user should have no privileges
on the computer (i.e. a non-root user).  The setup procedure
will give this user/group some permissions in specific paths/files
to perform server-specific operations.

If you have not yet created a user and group for the server,
create this user and group using your native operating
system utilities.

System User [dirsrv]:
System Group [dirsrv]:

==============================================================================
The standard directory server network port number is 389.  However, if
you are not logged as the superuser, or port 389 is in use, the
default value will be a random unused port number greater than 1024.
If you want to use port 389, make sure that you are logged in as the
superuser, that port 389 is not in use.

Directory server network port [389]:

==============================================================================
Each instance of a directory server requires a unique identifier.
This identifier is used to name the various
instance specific files and directories in the file system,
as well as for other uses as a server instance identifier.

Directory server identifier [ldap01]:

==============================================================================
The suffix is the root of your directory tree.  The suffix must be a valid DN.
It is recommended that you use the dc=domaincomponent suffix convention.
For example, if your domain is example.com,
you should use dc=example,dc=com for your suffix.
Setup will create this initial suffix for you,
but you may have more than one suffix.
Use the directory server utilities to create additional suffixes.

Suffix [dc=vlan011, dc=cnta, dc=local]:

==============================================================================
Certain directory server operations require an administrative user.
This user is referred to as the Directory Manager and typically has a
bind Distinguished Name (DN) of cn=Directory Manager.
You will also be prompted for the password for this user.  The password must
be at least 8 characters long, and contain no spaces.
Press Control-B or type the word "back", then Enter to back up and start over.

Directory Manager DN [cn=Directory Manager]:
Password:
Password (confirm):
Your new DS instance 'ldap01' was successfully created.
Exiting . . .
Log file is '/tmp/setupMvc_yo.log'
----

. ldapsearchの実行
+
----
# ldapsearch -D "cn=Directory Manager" -w password -b dc=vlan011,dc=cnta,dc=local *
# extended LDIF
#
# LDAPv3
# base <dc=vlan011,dc=cnta,dc=local> with scope subtree
# filter: (objectclass=*)
# requesting: anaconda-ks.cfg
#

# vlan011.cnta.local
dn: dc=vlan011,dc=cnta,dc=local

# Directory Administrators, vlan011.cnta.local
dn: cn=Directory Administrators,dc=vlan011,dc=cnta,dc=local

# Groups, vlan011.cnta.local
dn: ou=Groups,dc=vlan011,dc=cnta,dc=local

# People, vlan011.cnta.local
dn: ou=People,dc=vlan011,dc=cnta,dc=local

# Special Users, vlan011.cnta.local
dn: ou=Special Users,dc=vlan011,dc=cnta,dc=local

# Accounting Managers, Groups, vlan011.cnta.local
dn: cn=Accounting Managers,ou=Groups,dc=vlan011,dc=cnta,dc=local

# HR Managers, Groups, vlan011.cnta.local
dn: cn=HR Managers,ou=Groups,dc=vlan011,dc=cnta,dc=local

# QA Managers, Groups, vlan011.cnta.local
dn: cn=QA Managers,ou=Groups,dc=vlan011,dc=cnta,dc=local

# PD Managers, Groups, vlan011.cnta.local
dn: cn=PD Managers,ou=Groups,dc=vlan011,dc=cnta,dc=local

# search result
search: 2
result: 0 Success

# numResponses: 10
# numEntries: 9
----

. firewallの穴あけ
+
----
# firewall-cmd --add-port=389/tcp --zone=public --permanent
# firewall-cmd --reload
----

=== phpLDAPadminの構成
. phpLDAPadminのインストール
+
----
# rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
# yum -y install phpldapadmin
----

. phpLDAPadminの設定ファイル変更
+
----
# vi /etc/phpldapadmin/config.php
(snip)
/* If you specified 'cookie' or 'session' as the auth_type above, you can
   optionally specify here an attribute to use when logging in. If you enter
   'uid' and login as 'dsmith', phpLDAPadmin will search for (uid=dsmith)
   and log in as that user.
   Leave blank or specify 'dn' to use full DN for logging in. Note also that if
   your LDAP server requires you to login to perform searches, you can enter the
   DN to use when searching in 'bind_id' and 'bind_pass' above. */
$servers->setValue('login','attr','dn');
// $servers->setValue('login','attr','uid');
----

. Apacheの設定ファイルの変更
+
----
+ vi /etc/httpd/conf.d/phpldapadmin.conf
Alias /phpldapadmin /usr/share/phpldapadmin/htdocs
Alias /ldapadmin /usr/share/phpldapadmin/htdocs
<Directory /usr/share/phpldapadmin/htdocs>
  <IfModule mod_authz_core.c>
    # Apache 2.4
    Require all granted
  </IfModule>
  <IfModule !mod_authz_core.c>
    # Apache 2.2
    Order Deny,Allow
    Deny from all
    Allow from 127.0.0.1
    Allow from ::1
    Allow from 10.0.0.1
    Allow from all
  </IfModule>
</Directory>
----

. apacheサービスの有効化と起動
+
----
# systemctl enable httpd
# systemctl start httpd
----

. firewallの穴あけ
+
----
# firewall-cmd --add-port=80/tcp --zone=public --permanent
# firewall-cmd --reload
----

. SELinuxの無効化（後日、変更予定）
+
----
# setenforce 1
----

. ユーザのグループ作成
+
[cols="1,2,4"]
.LDAP構成
|===
|389 Directory Server IPアドレス
|10.1.11.108
|

|ドメイン名
|vlan011.cnta.local
|

|ユーザ格納用フォルダ(DN)
|OU=user,DC=vlan011,DC=cnta,DC=local
|

|グループ格納用フォルダ(DN)
|OU=user,DC=vlan011,DC=cnta,DC=local
|

|Bind DN
|CN=admin,OU=user,DC=vlan011,DC=cnta,DC=local
|ユーザを検索する際に使用するユーザ名
|===


=== ユーザの属性確認
. ldapsearchを実行
+
ユーザ（akiyoshi)の属性を確認する
+
.ldapsearchコマンドの実行
----
# ldapsearch -D "CN=admin,OU=user,DC=vlan011,DC=cnta,DC=local" -w password -H ldap://10.1.11.108/ -b "DC=vlan011,DC=cnta,DC=local" -s sub "CN=akiyoshi"
----
+
.ldapsearchコマンドの出力結果
----
# extended LDIF
#
# LDAPv3
# base <DC=vlan011,DC=cnta,DC=local> with scope subtree
# filter: CN=akiyoshi
# requesting: ALL
#

# akiyoshi, user, vlan011.cnta.local
dn: cn=akiyoshi,ou=user,dc=vlan011,dc=cnta,dc=local
givenName: akiyoshi
sn: yonekura
uid: ayonekura
uidNumber: 1000
gidNumber: 500
homeDirectory: /home/users/ayonekura
loginShell: /bin/sh
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: top
objectClass: organizationalPerson
objectClass: person
cn: akiyoshi

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1
----

. LDAPユーザの場合、一般的にはuid属性を検索属性やマッピング先のユーザとして使用します。

=== Active DirectoryをIdentity Providerとして登録する
. /etc/origin/master/master-config.yamlを修正(すべてのMasterノードで実施)
+
LDAPサーバIPアドレスやBindDN情報などは環境に合わせて変更してください。
+
.oauthConfig.indentityProvidersに以下を追加
----
  - name: "389 Directory Server"
    challenge: true
    login: true
    mappingMethod: claim
    provider:
      apiVersion: v1
      kind: LDAPPasswordIdentityProvider
      attributes:
        id:
        - dn
        email:
        - mail
        name:
        - cn
        preferredUsername:
        - uid
      bindDN: "CN=admin,OU=user,DC=vlan011,DC=cnta,DC=local"
      bindPassword: "password"
      ca: ""
      insecure: true
      url: "ldap://ldap01.vlan011.cnta.local/ou=user,dc=vlan011,dc=cnta,dc=local?uid"
----

+
.htpasswdなど他のidentityProviderが登録されている場合、oauthConfig.indentityProvidersの設定は以下のようになります。
----
oauthConfig:
  assetPublicURL: https://master01.cnta.local:8443/console/
  grantConfig:
    method: auto
  identityProviders:
  - challenge: true
    login: true
    mappingMethod: claim
    name: htpasswd_auth
    provider:
      apiVersion: v1
      file: /etc/origin/master/htpasswd
      kind: HTPasswdPasswordIdentityProvider
  - name: "389 Directory Server"
    challenge: true
    login: true
    mappingMethod: claim
    provider:
      apiVersion: v1
      kind: LDAPPasswordIdentityProvider
      attributes:
        id:
        - dn
        email:
        - mail
        name:
        - cn
        preferredUsername:
        - uid
      bindDN: "CN=admin,OU=user,DC=vlan011,DC=cnta,DC=local"
      bindPassword: "password"
      ca: ""
      insecure: true
      url: "ldap://ldap01.vlan011.cnta.local/ou=user,dc=vlan011,dc=cnta,dc=local?uid"
----

. master APIとcontrollersを再起動します。（すべてのMasterノードで実施)
+
----
master-restart api
master-restart controllers
----

. WebConsoleへのログイン
+
IdentityProviderの選択画面になる
+
.IdentityProviderの選択画面
image::.images/2019-08-20-18-36-34.png[]

+
ActiveDirectoryを選択すると見慣れがログイン画面が出てくる
+
.ログイン画面
image::.images/2019-08-20-19-04-42.png[]

=== OCPユーザ削除方法
. identityリソースとuserリソースから該当のユーザの削除を行います。なお、identityリソースを消さず、userリソースだけ消した場合で、再度ログインしようとするとauthentication_errorでログインに失敗する事象にあたりました。某銀行の操作手順に助けられました。

+
----
# oc get identity
NAME                                                                   IDP NAME               IDP USER NAME                                     USER NAME   USER UID
389 Directory Server:cn=akiyoshi,ou=user,dc=vlan011,dc=cnta,dc=local   389 Directory Server   cn=akiyoshi,ou=user,dc=vlan011,dc=cnta,dc=local   ayonekura   6cdcdf2a-c330-11e9-af39-0050569e03a6
htpasswd_auth:admin                                                    htpasswd_auth          admin                                             admin       0c551823-b3a4-11e9-baf1-0050569ea59b

# oc delete identity "389 Directory Server:cn=akiyoshi,ou=user,dc=vlan011,dc=cnta,dc=local"
----

+
----
# oc get user
NAME        UID                                    FULL NAME   IDENTITIES
admin       0c551823-b3a4-11e9-baf1-0050569ea59b               htpasswd_auth:admin
ayonekura   6cdcdf2a-c330-11e9-af39-0050569e03a6   akiyoshi    389 Directory Server:cn=akiyoshi,ou=user,dc=vlan011,dc=cnta,dc=local

# oc delete ayonekura
----


== トラブルシュート
. web ConsoleのURLを確認
ログイン失敗の原因は、URLを見ると確認できる。
.. 失敗例1: ActiveDirectoryに接続する際の認証に失敗
+
.ActiveDirectory接続時の認証に失敗
image::.images/2019-07-25-17-15-16.png[]
+
.URL
----
https://master01.cnta.local:8443/login/ActiveDirectory?reason=authentication_error&then=%2Foauth%2Fauthorize%3Fclient_id%3Dopenshift-web-console%26idp%3DActiveDirectory%26redirect_uri%3Dhttps%253A%252F%252Fmaster01.cnta.local%253A8443%252Fconsole%252Foauth%26response_type%3Dcode%26state%3DeyJ0aGVuIjoiL2NhdGFsb2ciLCJub25jZSI6IjE1NjQwNDI0NjAxNzQtMjgxMDU3NDQ2NTE2MjAxNDQ0MTEyODA5MzQ5ODIzMTg4NDc4NjkzNjMxOTY4MDg3MTk3NjAwMDUxNjUyMjI3NzM2MTExNDgwMjEyMSJ9
----
+
原因として、Bind DNとパスワードが適切に設定されていない可能性が考えられます。

.. 失敗例2: 他のIdentity Providerで同名のユーザ作成済みの場合
+
.他のIdentity Providerで同名のユーザ作成済みの場合
image::.images/2019-07-25-17-24-33.png[]
+
.URL
----
https://master01.cnta.local:8443/login/ActiveDirectory?reason=mapping_claim_error&then=%2Foauth%2Fauthorize%3Fclient_id%3Dopenshift-web-console%26idp%3DActiveDirectory%26redirect_uri%3Dhttps%253A%252F%252Fmaster01.cnta.local%253A8443%252Fconsole%252Foauth%26response_type%3Dcode%26state%3DeyJ0aGVuIjoiL2NhdGFsb2ciLCJub25jZSI6IjE1NjQwNDI0NjAxNzQtMjgxMDU3NDQ2NTE2MjAxNDQ0MTEyODA5MzQ5ODIzMTg4NDc4NjkzNjMxOTY4MDg3MTk3NjAwMDUxNjUyMjI3NzM2MTExNDgwMjEyMSJ9
----
+
解決方法は、mappingMethodを変更することで可能（試してはない）。mappingMethodはデフォルト値がclaimで、すでに他のidentity providerでmappingを作成していた場合、つまり、OCP上にユーザ名が作成済みの場合は、別名で登録することとなく失敗する。generateに変更すると、同名が存在した場合は、自動で別名前をつけて登録を行う。

.. 失敗例3: Access Denied
+
.Access Denied
image::.images/2019-07-25-17-34-04.png[]
+
.URL
----
https://master01.cnta.local:8443/login/ActiveDirectory?reason=access_denied&then=%2Foauth%2Fauthorize%3Fclient_id%3Dopenshift-web-console%26idp%3DActiveDirectory%26redirect_uri%3Dhttps%253A%252F%252Fmaster01.cnta.local%253A8443%252Fconsole%252Foauth%26response_type%3Dcode%26state%3DeyJ0aGVuIjoiL2NhdGFsb2ciLCJub25jZSI6IjE1NjQwNDI0NjAxNzQtMjgxMDU3NDQ2NTE2MjAxNDQ0MTEyODA5MzQ5ODIzMTg4NDc4NjkzNjMxOTY4MDg3MTk3NjAwMDUxNjUyMjI3NzM2MTExNDgwMjEyMSJ9
----
+
原因は、urlやinsecureの設定にある可能性が高い。ldapサーバへの疎通や検索対象の属性を確認する